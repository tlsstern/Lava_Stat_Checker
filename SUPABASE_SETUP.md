# Supabase Integration Setup

This application now supports Supabase for caching player statistics to reduce API calls and improve performance.

## Database Setup

1. Create a new Supabase project at [supabase.com](https://supabase.com)

2. Run the following SQL in your Supabase SQL editor to create the necessary tables:

```sql
-- Create players table (if not exists)
CREATE TABLE IF NOT EXISTS players (
    uuid TEXT PRIMARY KEY,
    player_name TEXT NOT NULL,
    category TEXT NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create stats table
CREATE TABLE IF NOT EXISTS stats (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    player_uuid TEXT NOT NULL REFERENCES public.players(uuid) ON DELETE CASCADE,
    player_ign TEXT NOT NULL,
    
    -- Player basic info
    level INT,
    exp BIGINT,
    
    -- Combat stats
    kills INT,
    deaths INT,
    kdr DECIMAL(10, 2),
    ws INT,
    wlr DECIMAL(10, 2),
    
    -- Prestige and ranking
    prestige TEXT,
    prestige_color TEXT,
    
    -- Detailed stats JSON
    detailed_stats JSONB,
    
    -- Metadata
    fetched_from TEXT, -- 'api' or 'scraper'
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    -- Create unique constraint on UUID + timestamp for history
    UNIQUE(player_uuid, created_at)
);

-- Create indexes for faster queries
CREATE INDEX idx_stats_player_uuid ON stats(player_uuid);
CREATE INDEX idx_stats_player_ign ON stats(player_ign);
CREATE INDEX idx_stats_updated_at ON stats(updated_at DESC);

-- Enable RLS
ALTER TABLE public.players ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.stats ENABLE ROW LEVEL SECURITY;

-- Create policies for public access (needed for insert/update operations)
CREATE POLICY "Public read access for players" ON public.players FOR SELECT USING (true);
CREATE POLICY "Public insert access for players" ON public.players FOR INSERT WITH CHECK (true);
CREATE POLICY "Public update access for players" ON public.players FOR UPDATE USING (true);

CREATE POLICY "Public read access for stats" ON public.stats FOR SELECT USING (true);
CREATE POLICY "Public insert access for stats" ON public.stats FOR INSERT WITH CHECK (true);
CREATE POLICY "Public update access for stats" ON public.stats FOR UPDATE USING (true);
CREATE POLICY "Public delete access for stats" ON public.stats FOR DELETE USING (true);

-- Create helper functions
CREATE OR REPLACE FUNCTION get_latest_stats(p_uuid TEXT)
RETURNS TABLE (
    player_uuid TEXT,
    player_ign TEXT,
    level INT,
    exp BIGINT,
    kills INT,
    deaths INT,
    kdr DECIMAL,
    ws INT,
    wlr DECIMAL,
    prestige TEXT,
    prestige_color TEXT,
    detailed_stats JSONB,
    fetched_from TEXT,
    updated_at TIMESTAMPTZ
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        s.player_uuid,
        s.player_ign,
        s.level,
        s.exp,
        s.kills,
        s.deaths,
        s.kdr,
        s.ws,
        s.wlr,
        s.prestige,
        s.prestige_color,
        s.detailed_stats,
        s.fetched_from,
        s.updated_at
    FROM stats s
    WHERE s.player_uuid = p_uuid
    ORDER BY s.updated_at DESC
    LIMIT 1;
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION get_latest_stats_by_ign(p_ign TEXT)
RETURNS TABLE (
    player_uuid TEXT,
    player_ign TEXT,
    level INT,
    exp BIGINT,
    kills INT,
    deaths INT,
    kdr DECIMAL,
    ws INT,
    wlr DECIMAL,
    prestige TEXT,
    prestige_color TEXT,
    detailed_stats JSONB,
    fetched_from TEXT,
    updated_at TIMESTAMPTZ
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        s.player_uuid,
        s.player_ign,
        s.level,
        s.exp,
        s.kills,
        s.deaths,
        s.kdr,
        s.ws,
        s.wlr,
        s.prestige,
        s.prestige_color,
        s.detailed_stats,
        s.fetched_from,
        s.updated_at
    FROM stats s
    WHERE LOWER(s.player_ign) = LOWER(p_ign)
    ORDER BY s.updated_at DESC
    LIMIT 1;
END;
$$ LANGUAGE plpgsql;
```

## Environment Variables

1. Copy `.env.example` to `.env`:
```bash
cp .env.example .env
```

2. Add your Supabase credentials:
```env
SUPABASE_URL=https://xxxxxxxxxxxxx.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

3. You can find these values in your Supabase project settings:
   - Go to Settings > API
   - Copy the "Project URL" for `SUPABASE_URL`
   - Copy the "anon public" key for `SUPABASE_ANON_KEY`

## Features

- **Automatic Caching**: Player stats are automatically cached in Supabase
- **UUID Tracking**: Players are tracked by UUID, handling name changes gracefully
- **Historical Data**: All stats are stored with timestamps for historical tracking
- **1-Hour Cache**: Cached data is used if less than 1 hour old
- **Fallback Support**: Works without Supabase (falls back to local cache)

## Cache Behavior

1. When a user searches for a player:
   - First checks Supabase cache (if less than 1 hour old)
   - If not cached or stale, fetches from API/scraper
   - Saves new data to Supabase for future requests

2. Player UUIDs are fetched from Mojang API and stored
3. Stats are linked to UUIDs, so name changes are handled automatically
4. Both API and scraper data are cached

## Monitoring

You can monitor cache usage in your Supabase dashboard:
- View the `stats` table to see cached player data
- Check the `players` table for UUID mappings
- Use the SQL editor to query historical stats

## Deployment on Render

Add these environment variables to your Render service:
1. Go to your service dashboard
2. Navigate to Environment > Environment Variables
3. Add `SUPABASE_URL` and `SUPABASE_ANON_KEY`
4. Redeploy your service